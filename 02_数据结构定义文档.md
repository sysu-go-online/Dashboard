# GO-ONLINE项目数据结构定义

## 用户定义项目(go-online.yml)

|名称|是否必须|默认值|可选项|类型|作用|
|--|--|--|--|--|--|
|Language|否|golang|golang、cpp|string|定义当前项目所属语言，系统在构建项目运行环境时需要用到|
|Username|否|用户在系统中的用户名|无|string|用户指定用户名，可能在在挂载时起作用，例如，go语言项目中，会将用户项目挂载到`$GOPATH/src/github.com/$Username/$projectname`目录|
|ProjectName|否|当前项目在系统中的项目名|无|string|用户指定项目名，作用同username|
|Environment|否|无|无|string=string:string list|用户定义环境变量，系统将在构建环境时附加这些环境变量|

## 系统定义相关目录

|名称|类型|值|作用|
|-|-|-|-|
|USER_HOME|string|/home/$USER_SYSTEM_NAME|储存用户的家目录，用户的所有文件都会被存储在家目录中|
|GOPATH|string|/root/go:/home/go|GOPATH，将会被同步设置到环境变量，第一个用来存放第三方库，第二个用来存放用户的项目|
|GO_PROJECT_DIR|string|$USER_HOME/go/src/github.com/$PROJECT_SYSTEM_NAME|储存用户golang项目源码的目录|
|GO_IMPORT_DIR|string|$USER_HOME/go/import|储存golang项目第三方库的目录|
|GO_PROJECT_MOUNT_DIR|string|/home/go/src/github.com/$Username/$ProjectName|用户的项目在**容器**中的挂载位置|
|GO_IMPORT_MOUNT_DIR|string|/root/go/|第三方库在**容器**中挂载的位置|
|CPP_PROJECT_DIR|string|$USER_HOME/cpp/$PROJECT_SYSTEM_NAME|用户的所有cpp\c项目根目录|
|CPP_MOUNT_DIR|string|/home/$Username/$ProjectName|用户当前cpp\c项目在**容器**中的挂载位置|

### 相关说明

1. c++项目暂不支持第三方库的使用，因此暂时不考虑cpp项目的lib路径
2. golang项目的第三方库和用户项目源码独立放置
3. 暂时用户项目只支持`github.com`前缀
4. 每次挂载到容器的项目有且只有当前用户使用的项目
5. 原则上每一条命令启动一个容器，用户的一切中间状态不予存储，当前的执行结果只在当前命令下有效
6. 用户有权使用任何命令，包括删除根目录的命令，但这同样会删除用户存储在服务器上的文件
7. 暂时只支持golang和c++两种语言
8. 所有golang项目共享同一个import目录
9. 系统定义环境变量优先用户定义环境变量
10. 环境变量内容应交给业务逻辑层传递

## 调试信息数据结构 [/ws/debug]

### 用户传入部分

|名称|类型|默认值|可选值|说明|
|-|-|-|-|-|-|
|BreakPoints|string:int|无|无|断点的文件:行数|
|Command|string|是|无|`run` `quit` `next` `continue` `set` `delete`|指定当前需要执行的命令|

### Command 说明

|命令|作用|涉及的用户字段|涉及的返回字段|
|-|-|-|-|
|run|开始调试程序|无|无|
|quit|终止并退出调试|无|无|
|next|下一条指令(不进入)|无|CurrentLine|
|continue|继续执行直到下一个断点/结束|无|CurrentLine|
|set|设置断点|BreakPoints|无|
|delete|删除断点|BreakPoints，此时格式为string，代表需要删除的系统代号|无|

### 系统返回部分

|名称|类型|默认值|可选值|说明|
|-|-|-|-|-|
|Event|string|无||调试过程中的事件|
|CurrentLine|string:int|无|无|当程序停止下来的时候，所在的行数|
|AddOn|string|无|无|附加信息|
|Message|string|无|无|信息，用于告知调试过程中发生的信息|

### 系统返回事件说明

|事件|说明|涉及的返回字段|
|-|-|-|
|done|当前请求完成|Message, CurrentLine, AddOn|
|finish|调试结束事件|无|
|stop|调试暂停事件|CurrentLine|
|error|运行中发生的错误，AddOn包含错误的信息，Message包含错误的类型|Message, AddOn|
|output|终端输出|Message|
|gdb|gdb的所有打印信息|Message|

#### 系统返回事件详细说明

- `done`

    可能的`Message`有

    - `bk-add` 表示断点添加成功，此时会包含`CurrentLine`以及`AddOn`，前者包含具体断点行数，后者代表当前断点的系统中编号

    - `loaded` 表示系统启动成功，可执行文件被成功加载
    
    - `bk-del` 表示删除断点完成，此时会包含`AddOn`，代表当前断点的系统中编号，请注意：**此时并不意味着断点删除成功，可能并不存在该断点，done只表示删除操作完成**

    - `running` 表示程序启动成功，正在运行

- `error`

    可能的`Message`有

    - `bk-add` 断点添加失败

    - `load` 文件加载失败

### 相关说明

1. 当前只支持开始、停止、设置/删除断点、单步执行、继续执行、查看变量值的功能
2. 客户端与服务端之间通过websocket连接
3. 信息传递采用json格式
4. 用户发送调试命令后，由服务端解析命令并启动调试容器，通过stdio进行交互
5. 调试容器内部存在一个程序，负责解析并传递参数给gdb进程

## JWT数据结构定义

### payload

|字段|类型|说明|
|-|-|-|
|sub|string|jwt所面向的用户，这里指的是用户的用户名|
|exp|int64|过期时间，默认为30天|
|iat|int64|jwt的签发时间|
|jti|string|jwt唯一的身份标识，这里使用一段随机的字符串表示|

### header

|字段|类型|说明|
|-|-|-|
|alg|string|加密用算法，默认为`HS256`|
|typ|string|token类型，这里时`JWT`|

### key(临时)

说明：用来对jwt进行加密解密的字符串，暂时为`go-online`

## 终端连接信息交互 [/ws/tty]

### 前端传入部分

|名称|类型|是否必须|说明|
|-|-|-|-|
|JWT|string|是|用户登录获得的jwt|
|Project|string|是|当前所在项目名|
|Command|string|是|用户的输入值，连接建立后第一次发送的为用户输入的命令，之后在该连接中传送用户输入的字符流|

### 后台返回部分

|名称|类型|是否必须|说明|
|-|-|-|-|
|err|string|否|当发生错误时，该字段用来告知错误信息，无错误时该字段为空或不存在|
|msg|string|是|后台终端的输出值，包括stdout和stderr|
